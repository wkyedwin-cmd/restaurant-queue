<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:15px;
}

h2 {
  text-align:center;
  font-size:26px;
}

.section-title {
  margin-top:35px;
  font-size:22px;
  font-weight:bold;
}

.card {
  background:white;
  padding:20px;
  margin-top:15px;
  border-radius:12px;
  box-shadow:0 3px 8px rgba(0,0,0,0.12);
  font-size:18px;
  line-height:1.6;
}

.queue-number {
  font-size:30px;
  font-weight:bold;
}

.customer-name {
  font-size:22px;
  font-weight:bold;
}

.table-number {
  font-size:28px;
  font-weight:bold;
  color:#d9534f;
}

.last-contacted {
  font-size:16px;
  color:gray;
  margin-top:5px;
}

button {
  padding:10px 14px;
  margin:8px 6px 0 0;
  border:none;
  border-radius:8px;
  font-size:16px;
}

.btn-confirm { background:#28a745; color:white; }
.btn-complete { background:#007bff; color:white; }
.btn-cancel { background:#dc3545; color:white; }
.btn-whatsapp { background:#25D366; color:white; }
.btn-whatsapp-clicked { background:gray; color:white; }

input {
  width:100%;
  padding:12px;
  margin-top:15px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}

hr {
  margin:45px 0;
  border:2px solid black;
}
</style>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhha-pRzGBXHfSO3PdZ0UmLgGtxfLWcPQ",
  authDomain: "yunnans-1u.firebaseapp.com",
  projectId: "yunnans-1u",
  storageBucket: "yunnans-1u.firebasestorage.app",
  messagingSenderId: "490439485047",
  appId: "1:490439485047:web:42d5ca722ade09c6b88872"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();
let allData = [];

function today(){
  return new Date().toISOString().split("T")[0];
}

function checkPassword(){
  if(document.getElementById("password").value==="1234"){
    document.getElementById("login").style.display="none";
    document.getElementById("panel").style.display="block";
    loadData();
  }else{
    alert("å¯†ç é”™è¯¯");
  }
}

function openWhatsApp(id, phone){
  if(!phone) return;

  const now = new Date();

  db.collection("queues").doc(id).update({
    lastContacted: firebase.firestore.Timestamp.fromDate(now)
  });

  window.open("https://wa.me/"+phone.replace("+",""),"_blank");
}

function updateStatus(id,status){
  let updateData = { status:status };
  if(status==="completed"||status==="cancelled"){
    updateData.finishedAt = firebase.firestore.FieldValue.serverTimestamp();
  }
  db.collection("queues").doc(id).update(updateData);
}

function assignTable(id){
  const tableNumber = prompt("è¯·è¾“å…¥æ¡Œå·:");
  if(!tableNumber) return;
  db.collection("queues").doc(id).update({
    status:"confirmed",
    tableNumber:tableNumber
  });
}

function formatTime(timestamp){
  if(!timestamp) return "";
  const date = timestamp.toDate();
  return date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function renderList(list, container){
  container.innerHTML="";
  list.forEach(item=>{
    container.innerHTML+=`
    <div class="card">
      <div class="queue-number">ğŸ†” ${item.queueNumber}</div>
      ğŸ“… ${item.date} | â° ${item.time}<br>

      <div class="customer-name">ğŸ‘¤ ${item.name}</div>
      ğŸ“ ${item.phone}<br>

      ğŸ‘¨ æˆäºº:${item.adults} ğŸ‘¶:${item.babyChairs}<br>

      <div class="table-number">ğŸ· æ¡Œå·: ${item.tableNumber||"-"}</div>

      ${item.lastContacted ? 
        `<div class="last-contacted">Last contacted: ${formatTime(item.lastContacted)}</div>` 
        : ""}

      ğŸ“Œ çŠ¶æ€:${item.status}<br>

      <button 
        class="${item.lastContacted ? 'btn-whatsapp-clicked' : 'btn-whatsapp'}"
        onclick="openWhatsApp('${item.id}','${item.phone}')">
        WhatsApp
      </button>

      ${item.status==="waiting" ?
      `<button class="btn-confirm" onclick="assignTable('${item.id}')">Confirm + Table</button>`:""}

      ${item.status==="confirmed" ?
      `<button class="btn-complete" onclick="updateStatus('${item.id}','completed')">Completed</button>`:""}

      <button class="btn-cancel" onclick="updateStatus('${item.id}','cancelled')">Cancel</button>
    </div>
    `;
  });
}

function applyFilter(){
  const keyword=document.getElementById("search").value.toLowerCase();
  let active=[], finished=[];

  allData.forEach(data=>{
    const match=
      (data.name||"").toLowerCase().includes(keyword)||
      (data.phone||"").includes(keyword)||
      String(data.queueNumber||"").includes(keyword);

    if(match){
      if(data.status==="waiting"||data.status==="confirmed"){
        active.push(data);
      }else{
        finished.push(data);
      }
    }
  });

  active.sort((a,b)=>(a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
  finished.sort((a,b)=>(b.finishedAt?.seconds||0)-(a.finishedAt?.seconds||0));

  renderList(active,document.getElementById("activeList"));
  renderList(finished,document.getElementById("finishedList"));
}

function loadData(){
  db.collection("queues")
  .where("date","==",today())
  .onSnapshot(snapshot=>{
    allData=[];
    snapshot.forEach(doc=>{
      allData.push({...doc.data(),id:doc.id});
    });
    applyFilter();
  });
}
</script>
</head>

<body>

<div id="login">
  <h2>Admin Login</h2>
  <input type="password" id="password">
  <button onclick="checkPassword()">Login</button>
</div>

<div id="panel" style="display:none;">
  <h2>åå°ç®¡ç†ç³»ç»Ÿ</h2>

  <input type="text" id="search" placeholder="ğŸ” æœç´¢åå­— / ç”µè¯ / æ’å·" oninput="applyFilter()">

  <div class="section-title">ğŸŸ¢ Waiting + Confirmed</div>
  <div id="activeList"></div>

  <hr>

  <div class="section-title">ğŸ”´ Cancelled + Completed</div>
  <div id="finishedList"></div>
</div>

</body>
</html>
