<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhha-pRzGBXHfSO3PdZ0UmLgGtxfLWcPQ",
  authDomain: "yunnans-1u.firebaseapp.com",
  projectId: "yunnans-1u",
  storageBucket: "yunnans-1u.firebasestorage.app",
  messagingSenderId: "490439485047",
  appId: "1:490439485047:web:42d5ca722ade09c6b88872"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function today(){
  return new Date().toISOString().split("T")[0];
}

function checkPassword(){
  const input = document.getElementById("password").value;
  if(input === "1234"){
    document.getElementById("login").style.display="none";
    document.getElementById("panel").style.display="block";
  }else{
    alert("å¯†ç é”™è¯¯");
  }
}

function updateStatus(id,status){
  db.collection("queues").doc(id).update({status:status});
}

function openWhatsApp(phone){
  const clean = phone.replace("+","");
  window.open("https://wa.me/"+clean,"_blank");
}

db.collection("queues").onSnapshot(snapshot=>{

  let waitingHTML = "<h3>ğŸŸ¡ Waiting</h3>";
  let seatedHTML = "<h3>ğŸŸ£ Seated</h3>";
  let completedHTML = "<h3>ğŸŸ¢ Completed</h3>";
  let cancelledHTML = "<h3>ğŸ”´ Cancelled</h3>";

  let total = 0;

  snapshot.forEach(doc=>{
    const data = doc.data();

    if(data.date === today()){
      total++;

      const block = `
      <div style="border:1px solid #ccc;margin:5px;padding:8px;">
      <b>${data.name || "-"}</b><br>
      ç”µè¯: ${data.phone || "-"}<br>
      æˆäºº: ${data.adults || 0} | å®å®æ¤…: ${data.babyChairs || 0}<br>
      åº§ä½: ${data.seatPreference || "-"}<br>
      æ¡Œå·: ${data.tableNumber || "-"}<br><br>

      <button onclick="openWhatsApp('${data.phone}')">ğŸ“± WhatsApp</button>

      ${data.status==="waiting" ?
      `<button onclick="confirmAndAssign('${doc.id}')">ç¡®è®¤åˆ°åº—+åˆ†æ¡Œ</button>` : ""}

      ${data.status==="seated" ?
      `<button onclick="updateStatus('${doc.id}','completed')">å…¥åº§å®Œæˆ</button>` : ""}

      <button onclick="updateStatus('${doc.id}','cancelled')">å–æ¶ˆ</button>
      </div>
      `;

      if(data.status==="waiting") waitingHTML+=block;
      if(data.status==="seated") seatedHTML+=block;
      if(data.status==="completed") completedHTML+=block;
      if(data.status==="cancelled") cancelledHTML+=block;
    }
  });

  document.getElementById("stats").innerHTML =
    "ä»Šæ—¥æ€»æ’é˜Ÿ: "+total;

  document.getElementById("waiting").innerHTML = waitingHTML;
  document.getElementById("seated").innerHTML = seatedHTML;
  document.getElementById("completed").innerHTML = completedHTML;
  document.getElementById("cancelled").innerHTML = cancelledHTML;

});

function confirmAndAssign(id){
  const tableNumber = prompt("è¯·è¾“å…¥æ¡Œå·:");
  if(!tableNumber){
    alert("å¿…é¡»è¾“å…¥æ¡Œå·");
    return;
  }

  db.collection("queues").doc(id).update({
    status:"seated",
    tableNumber: tableNumber
  });
}
</script>
</head>

<body>

<div id="login">
  <h2>Admin Login</h2>
  <input type="password" id="password">
  <button onclick="checkPassword()">Login</button>
</div>

<div id="panel" style="display:none;">

<h2>åå°ç®¡ç†ç³»ç»Ÿ</h2>
<div id="stats"></div>

<div id="waiting"></div>
<hr>
<div id="seated"></div>
<hr>
<div id="completed"></div>
<hr>
<div id="cancelled"></div>

</div>

</body>
</html>
