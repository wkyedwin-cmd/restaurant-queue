<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Restaurant Queue</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhha-pRzGBXHfSO3PdZ0UmLgGtxfLWcPQ",
  authDomain: "yunnans-1u.firebaseapp.com",
  projectId: "yunnans-1u",
  storageBucket: "yunnans-1u.firebasestorage.app",
  messagingSenderId: "490439485047",
  appId: "1:490439485047:web:42d5ca722ade09c6b88872"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();

function getDailyLetter() {
  const today = new Date();
  const start = new Date(today.getFullYear(), 0, 0);
  const diff = today - start;
  const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  return letters[dayOfYear % 26];
}

async function generateDailyQueueNumber() {
  const today = new Date().toISOString().split("T")[0];
  const dailyLetter = getDailyLetter();

  while (true) {
    const randomNumber = Math.floor(Math.random() * 999) + 1;
    const formattedNumber = String(randomNumber).padStart(3, "0");
    const fullQueueNumber = dailyLetter + formattedNumber;

    const snapshot = await db.collection("queues")
      .where("date","==",today)
      .where("queueNumber","==",fullQueueNumber)
      .get();

    if (snapshot.empty) {
      return fullQueueNumber;
    }
  }
}

async function submitForm(e){
  e.preventDefault();

  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value.trim();
  const adults = parseInt(document.getElementById("adults").value);
  const babyChairs = parseInt(document.getElementById("babyChairs").value);
  const seating = document.getElementById("seating").value;

  if(!phone.startsWith("+")){
    alert("电话号码必须包含国家代码，例如 +60123456789");
    return;
  }

  const queueNumber = await generateDailyQueueNumber();
  const today = new Date().toISOString().split("T")[0];
  const time = new Date().toLocaleTimeString();

  await db.collection("queues").add({
    queueNumber: queueNumber,
    name: name,
    phone: phone,
    adults: adults,
    babyChairs: babyChairs,
    seating: seating,
    status: "waiting",
    date: today,
    time: time,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("您的排号是: " + queueNumber);
  document.getElementById("queueForm").reset();

  // 重置后重新填回 +60
  document.getElementById("phone").value = "+60";
}
</script>
</head>

<body>

<h2>餐厅排号系统</h2>

<form id="queueForm" onsubmit="submitForm(event)">

姓名 Name:<br>
<input type="text" id="name" required><br><br>

电话 Phone (默认 +60，可修改国际号):<br>
<input 
  type="tel" 
  id="phone" 
  value="+60"
  required
  style="width:250px;padding:6px;"
><br><br>

成人 Adults:<br>
<input type="number" id="adults" min="1" required><br><br>

宝宝椅 Baby Chairs:<br>
<input type="number" id="babyChairs" min="0" value="0"><br><br>

座位选择 Seating:<br>
<select id="seating">
  <option value="indoor">室内 Indoor</option>
  <option value="outdoor">室外 Outdoor</option>
  <option value="any">随意 Fastest Available</option>
</select><br><br>

<button type="submit">提交 Submit</button>

</form>

</body>
</html>
