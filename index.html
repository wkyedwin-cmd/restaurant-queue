<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant Queue</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- intl tel input -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/css/intlTelInput.css"/>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/intlTelInput.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f4f4f4;
  display: flex;
  justify-content: center;
  padding: 20px;
}

.container {
  background: white;
  width: 100%;
  max-width: 420px;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

h2 {
  text-align: center;
  margin-bottom: 20px;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 12px;
}

input, select {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-top: 6px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  margin-top: 20px;
  border-radius: 10px;
  border: none;
  background-color: #007bff;
  color: white;
  font-weight: bold;
}

button:hover {
  background-color: #0056b3;
}
</style>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhha-pRzGBXHfSO3PdZ0UmLgGtxfLWcPQ",
  authDomain: "yunnans-1u.firebaseapp.com",
  projectId: "yunnans-1u",
  storageBucket: "yunnans-1u.firebasestorage.app",
  messagingSenderId: "490439485047",
  appId: "1:490439485047:web:42d5ca722ade09c6b88872"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();
let phoneInput;

window.onload = function(){
  phoneInput = window.intlTelInput(document.querySelector("#phone"), {
    initialCountry: "my",
    preferredCountries: ["my","sg","cn"],
    separateDialCode: false,
    utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/utils.js"
  });
};

function getDailyLetter() {
  const today = new Date();
  const start = new Date(today.getFullYear(), 0, 0);
  const diff = today - start;
  const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  return letters[dayOfYear % 26];
}

async function generateDailyQueueNumber() {
  const today = new Date().toISOString().split("T")[0];
  const dailyLetter = getDailyLetter();

  while (true) {
    const randomNumber = Math.floor(Math.random() * 999) + 1;
    const formattedNumber = String(randomNumber).padStart(3, "0");
    const fullQueueNumber = dailyLetter + formattedNumber;

    const snapshot = await db.collection("queues")
      .where("date","==",today)
      .where("queueNumber","==",fullQueueNumber)
      .get();

    if (snapshot.empty) return fullQueueNumber;
  }
}

async function submitForm(e){
  e.preventDefault();

  if(!phoneInput.isValidNumber()){
    alert("请输入正确的电话号码 / Please enter valid phone number");
    return;
  }

  const queueNumber = await generateDailyQueueNumber();

  await db.collection("queues").add({
    queueNumber: queueNumber,
    name: document.getElementById("name").value,
    phone: phoneInput.getNumber(),
    adults: parseInt(document.getElementById("adults").value),
    babyChairs: parseInt(document.getElementById("babyChairs").value),
    seating: document.getElementById("seating").value,
    status: "waiting",
    date: new Date().toISOString().split("T")[0],
    time: new Date().toLocaleTimeString(),
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("您的排号是: " + queueNumber);
  document.getElementById("queueForm").reset();
  phoneInput.setCountry("my");
}
</script>
</head>

<body>

<div class="container">
<h2>餐厅排号系统</h2>

<form id="queueForm" onsubmit="submitForm(event)">

<label>姓名 Name</label>
<input type="text" id="name" required>

<label>电话 Phone</label>
<input type="tel" id="phone" required>

<label>成人 Adults</label>
<input type="number" id="adults" min="1" required>

<label>宝宝椅 Baby Chairs</label>
<input type="number" id="babyChairs" min="0" value="0">

<label>座位选择 Seating</label>
<select id="seating">
  <option value="indoor">室内 Indoor</option>
  <option value="outdoor">室外 Outdoor</option>
  <option value="any">随意 Fastest Available</option>
</select>

<button type="submit">提交 Submit</button>

</form>
</div>

</body>
</html>
